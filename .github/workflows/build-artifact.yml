name: Build Static Artifact

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      upload_to_s3:
        description: 'Upload artifact to S3'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  build-artifact:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run build script
      run: ./build-artifact.sh

    - name: Upload artifact to GitHub Actions
      uses: actions/upload-artifact@v4
      with:
        name: racker-stacker-${{ github.sha }}
        path: artifacts/*.tar.gz
        retention-days: 30

    # Delete existing 'latest' release and tag for main branch pushes
    - name: Delete Latest Release
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: dev-drprasad/delete-tag-and-release@v1.1
      with:
        tag_name: latest
        github_token: ${{ secrets.GITHUB_TOKEN }}
        delete_release: true
      continue-on-error: true

    # Create 'latest' release for main branch
    - name: Create Latest Release
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: latest
        name: Latest Build
        files: artifacts/*.tar.gz
        prerelease: true
        generate_release_notes: false
        body: |
          ## Latest Build from Main Branch

          **‚ö†Ô∏è This is an automated build from the latest commit on the main branch.**

          - Commit: ${{ github.sha }}
          - Branch: main
          - Build Date: ${{ github.event.head_commit.timestamp }}

          ### Quick Download

          **üì¶ [Download racker-stacker-latest.tar.gz](../../releases/download/latest/racker-stacker-latest.tar.gz)**

          ### Deployment

          To deploy the artifact:
          ```bash
          # Download and extract
          wget https://github.com/${{ github.repository }}/releases/download/latest/racker-stacker-latest.tar.gz
          tar -xzf racker-stacker-latest.tar.gz

          # Serve with your preferred web server
          ```

          ### What's Included
          - Minified and optimized JavaScript/CSS
          - All required static assets
          - Build metadata (build-info.json)

          **Note:** This release is automatically updated with each push to main branch.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Upload to S3 if configured (requires AWS credentials in secrets)
    - name: Configure AWS credentials
      if: github.event.inputs.upload_to_s3 == 'true' || startsWith(github.ref, 'refs/tags/v')
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
      continue-on-error: true

    - name: Upload to S3
      if: github.event.inputs.upload_to_s3 == 'true' || startsWith(github.ref, 'refs/tags/v')
      run: |
        if [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
          S3_BUCKET="${{ secrets.S3_BUCKET || 'racker-stacker-artifacts' }}"

          # Upload versioned artifact
          for file in artifacts/*.tar.gz; do
            if [[ $file != *"latest"* ]]; then
              aws s3 cp "$file" "s3://${S3_BUCKET}/releases/" --acl public-read || true
            fi
          done

          # Upload latest version
          if [ -f "artifacts/racker-stacker-latest.tar.gz" ]; then
            aws s3 cp "artifacts/racker-stacker-latest.tar.gz" "s3://${S3_BUCKET}/" --acl public-read || true
          fi

          echo "Artifacts uploaded to S3 bucket: ${S3_BUCKET}"
        else
          echo "AWS credentials not configured, skipping S3 upload"
        fi
      continue-on-error: true

    # Create GitHub Release for tags
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: artifacts/*.tar.gz
        generate_release_notes: true
        body: |
          ## Static Build Artifact

          This release contains the production-ready static build of Racker-Stacker.

          ### Deployment

          To deploy the artifact:
          1. Download the tar.gz file
          2. Extract to your web server: `tar -xzf racker-stacker-*.tar.gz`
          3. Serve the static files with any web server (nginx, Apache, S3, etc.)

          ### What's Included
          - Minified and optimized JavaScript/CSS
          - All required static assets
          - Build metadata (build-info.json)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}